<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	    <title>Buzz Guardian</title>

	    <script type="text/javascript" src="./scripts/jquery.min.js"></script>
    	<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAmEvPWMafJFafvXGR-ampYOLQVSWmP5xM&sensor=false"></script>
    	<script src="http://code.jquery.com/jquery.min.js"></script>
    	<script src="./scripts/home.js"></script>

	    <link href="./css/bootstrap.css" rel="stylesheet">
	    <link href="./css/home.css" rel="stylesheet">

	    <script type="text/javascript">
	   
	    </script>

	      <script>
    var lastUpdate = '0';

    var allMarkers = [];

    function autoUpdate() {
      $.ajax({
        type: "GET",
        url: "/BuzzGuardian/EmergencyMap",
        dataType: 'json',
        success: function(jsonData) {

          // 1. Check if jsonData is empty. If empty skip to 4.
          //    Else we received some fresh data.
          //

          if(!jQuery.isEmptyObject(jsonData)) {

            // 2. Update lastUpdate from the jsonData with the timestamp from
            //    the server. Don't use JavaScript to update the timestamp,
            //    because the time on the client and on the server will
            //    never be exactly in sync.
            //

            lastUpdate = jsonData.timestamp;

            // 3. Add new markers on Google Map.
            //

            var locations = jsonData.locations;


            $.each(locations, addMarker);

            for (var i=0; i < allMarkers.length; i++) {

              if (i == 0) {
                allMarkers[i].setIcon(start)
              }

              else if (i == allMarkers.length - 1) {
                allMarkers[i].setIcon(finish)
              }

              else {

                allMarkers[i].setIcon(path)
              }

            }



          }
          // 4. Relaunch the autoUpdate() function in 5 seconds.
          setTimeout(autoUpdate, 5000);
        }
      });
    }

    var map;
    var start = './images/start.png';
    var finish = './images/finish.png';
    var path = './images/path.png';

    function initialize() {
      var gatech = new google.maps.LatLng(33.77658,-84.38993)
      var mapOptions = {
        zoom: 15,
        center: gatech,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
    }

    // Function for adding a marker to the page.
    function addMarker(index, raw_location) {
      map.setZoom(10);
      var location = new google.maps.LatLng(raw_location[0],raw_location[1]);
      console.log(location)
      marker = new google.maps.Marker({
        position: location,
        map: map,
        icon: finish
      });
      allMarkers.push(marker);
      map.setZoom(15); // Zoom in after 1 sec
      map.panTo(location);
    }


    </script>

	</head>
<body onload="initialize(); autoUpdate();">
	<nav class="navbar navbar-custom navbar-static-top">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="#">Emergency Response System</a>
  </div>
  <div class="collapse navbar-collapse">
    <ul class="nav navbar-nav">
      <li class="active"><a href="#">Home</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
      <li><a href="#" id="logoutLnk">Logout</a></li>
    </ul>
  </div><!-- /.navbar-collapse -->
</nav>
  <div id="map-container" class="container">

      <h1 class="">Emergency map</h1>
      <p class="">These are the latest emergency requests.</p>

      <div id="map-canvas"></div>

    </div> <!-- /container -->



	<script type="text/javascript" src="./scripts/bootstrap.js"></script>
</body>

</html>